<div
  class="flex flex-col gap-2 md:pl-4 w-full h-full max-h-[calc(100vh_-_7rem)]"
>
  <div
    class="flex flex-col sm:flex-row justify-start items-center flex-wrap gap-x-4 gap-y-1"
  >
    <div class="flex flex-row w-full justify-between my-2 gap-1">
      <div
        class="w-1/2 flex flex-col md:flex-row justify-between md:justify-start"
      >
        <h1 class="font-bold text-4xl text-left text-base-content md:mr-4 mb-2">
          Reservas
        </h1>
        @if (authService.usuario()?.rol?.nombre?.toLowerCase() ===
        'administrador') {
        <button
          (click)="navegarAdminReservas()"
          class="btn btn-accent max-sm:btn-sm md:h-11 rounded-box"
        >
          <app-web-icon
            nombreIcono="calendar-number-outline"
            estilos="h-5 w-5 mr-1 max-sm:hidden"
          >
          </app-web-icon>
          <span class="max-lg:hidden text-sm md:text-base"
            >Administrar reservas</span
          >
          <span class="hidden max-lg:inline text-sm md:text-base"
            >Administrar</span
          >
        </button>
        }
      </div>
      <div
        class="flex flex-col md:flex-row gap-2 w-1/2 justify-between md:justify-end"
      >
        @if (hasFilters()) {
        <button
          class="btn btn-warning max-sm:btn-sm md:h-11 rounded-box"
          (click)="limpiarTodosFiltros()"
          [attr.title]="'Limpiar filtros: ' + filtrosActivos().join(', ')"
        >
          <app-web-icon
            nombreIcono="close-circle-outline"
            estilos="h-5 w-5 mr-1 max-sm:hidden"
          >
          </app-web-icon>
          <span class="max-lg:hidden text-sm md:text-base"
            >Limpiar filtros</span
          >
          <span class="hidden max-lg:inline text-sm md:text-base">Limpiar</span>
        </button>
        }

        <button
          (click)="navegarMisReservas()"
          class="btn btn-primary max-sm:btn-sm md:h-11 rounded-box"
        >
          <app-web-icon
            nombreIcono="file-tray-full-outline"
            estilos="h-5 w-5 mr-1 max-sm:hidden"
          >
          </app-web-icon>
          <span class="max-lg:hidden text-sm md:text-base"
            >Historial de reservas</span
          >
          <span class="hidden max-lg:inline text-sm md:text-base"
            >Historial</span
          >
        </button>
      </div>
    </div>

    <form
      [formGroup]="filtrosForm"
      class="grid gap-1 w-full items-center grid-cols-[repeat(auto-fit,minmax(11rem,1fr))]"
    >
      <div class="flex flex-col items-center flex-1 md:max-w-56">
        <label
          class="label w-full text-sm font-[600] text-base-content mb-0 px-1"
          for="fecha"
        >
          Seleccione la fecha:
        </label>
        <div class="flex items-center w-full px-1">
          <label
            class="input max-sm:input-sm input-bordered w-full md:h-11 rounded-box"
            [ngClass]="{ 'text-gray-400': !filtrosForm.value.fecha }"
          >
            <input
              autocomplete="off"
              id="fecha"
              name="fecha"
              formControlName="fecha"
              type="text"
              #fechaPicker
              placeholder="dd/mm/yyyy"
              class="grow pika-single placeholder:text-gray-400 placeholder:text-xs md:placeholder:text-sm"
            />
            <app-web-icon
              [nombreIcono]="'calendar-outline'"
              [estilos]="'h-5 w-5'"
            >
            </app-web-icon>
          </label>
        </div>
      </div>

      <div class="flex flex-col items-center flex-1 md:max-w-56">
        <label
          class="label w-full text-sm font-[600] text-base-content mb-0 px-1"
          for="grupo"
        >
          Grupo:
        </label>
        <div class="flex items-center w-full px-1">
          <select
            id="grupo"
            name="grupo"
            formControlName="grupo"
            class="select max-sm:select-sm grow input-bordered w-full md:h-11 rounded-box"
          >
            <option value="" disabled>Seleccione</option>
            @for (grupo of appService.gruposQuery.data(); track grupo.id) {
            <option [value]="grupo.id">
              {{ grupo.nombre | upperFirst }}
            </option>
            }
          </select>

          @if (filtrosForm.value.grupo) {
          <button
            class="btn max-sm:btn-xs btn-sm btn-error btn-soft btn-circle tooltip tooltip-left lg:tooltip-right ml-1 xl:ml-2"
            data-tip="Limpiar grupo"
            (click)="limpiarGrupo()"
          >
            <app-web-icon
              nombreIcono="close-circle-outline"
              estilos="max-sm:h-5 max-sm:w-5 h-6 w-6"
            >
            </app-web-icon>
          </button>
          }
        </div>
      </div>

      <div class="flex flex-col items-center flex-1 md:max-w-56">
        <label
          class="label w-full text-sm font-[600] text-base-content mb-0 px-1"
          for="categoria"
        >
          Categoría:
        </label>
        <div class="flex items-center w-full px-1">
          <select
            id="categoria"
            name="categoria"
            formControlName="categoria"
            class="select max-sm:select-sm grow input-bordered w-full md:h-11 rounded-box"
          >
            <option value="" disabled>Seleccione</option>
            @for (categoria of appService.categoriasQuery.data(); track
            categoria.id) {
            <option [value]="categoria.id">
              {{ categoria.nombre | upperFirst }}
            </option>
            }
          </select>

          @if (filtrosForm.value.categoria) {
          <button
            class="btn max-sm:btn-xs btn-sm btn-error btn-soft btn-circle tooltip tooltip-left lg:tooltip-right ml-1 xl:ml-2"
            data-tip="Limpiar tipo de espacio"
            (click)="limpiarCategoria()"
          >
            <app-web-icon
              nombreIcono="close-circle-outline"
              estilos="max-sm:h-5 max-sm:w-5 h-6 w-6"
            >
            </app-web-icon>
          </button>
          }
        </div>
      </div>

      <div class="flex flex-col items-center flex-1 md:max-w-56">
        <label
          class="label w-full text-sm font-[600] text-base-content mb-0 px-1"
          for="sede"
        >
          Ubicación:
        </label>
        <div class="flex items-center w-full px-1">
          <select
            id="sede"
            name="sede"
            formControlName="sede"
            class="select max-sm:select-sm grow input-bordered w-full md:h-11 rounded-box"
          >
            <option value="" disabled>Seleccione</option>
            @for (sede of appService.sedesQuery.data(); track sede.id) {
            <option [value]="sede.id">
              {{ sede.nombre | upperFirst }}
            </option>
            }
          </select>

          @if (filtrosForm.value.sede) {
          <button
            class="btn max-sm:btn-xs btn-sm btn-error btn-soft btn-circle tooltip tooltip-left lg:tooltip-right ml-1 xl:ml-2"
            data-tip="Limpiar ubicación"
            (click)="limpiarUbicacion()"
          >
            <app-web-icon
              nombreIcono="close-circle-outline"
              estilos="max-sm:h-5 max-sm:w-5 h-6 w-6"
            >
            </app-web-icon>
          </button>
          }
        </div>
      </div>
    </form>
  </div>

  @if (isLoadingEspacios()) {
  <div
    class="flex flex-col items-center justify-center w-full py-16 text-center"
  >
    <div class="loading loading-spinner loading-lg text-primary mb-4"></div>
    <h3 class="text-lg font-semibold text-base-content/70 mb-2">
      Cargando espacios...
    </h3>
    <p class="text-base-content/50">
      Por favor espere mientras consultamos la disponibilidad.
    </p>
  </div>
  } @else if (espacios().length > 0) {
  <div
    class="grid w-full h-full justify-center sm:justify-start auto-rows-[15rem] grid-cols-[repeat(auto-fit,11rem)] overflow-y-auto gap-4 mt-2 place-items-center"
  >
    @for (espacio of espacios(); track trackByEspacioId($index, espacio)) {
    <espacio-booking-item
      [ubicacion]="espacio.sede"
      [titulo]="espacio.nombre"
      [imagenUrl]="getImagenUrl(espacio.imagen_url)"
      (abrirEspacioEvent)="abrirEspacio(espacio.id)"
    >
    </espacio-booking-item>
    }
  </div>

  } @else {
  <div
    class="alert alert-error alert-dash flex flex-col gap-1 items-center justify-center w-full text-center"
  >
    <app-web-icon
      [nombreIcono]="'search-circle-outline'"
      [estilos]="'h-16 w-16'"
    >
    </app-web-icon>
    <h3 class="text-2xl font-semibold mb-1">No se encontraron espacios</h3>
    <p class="text-lg">
      Intenta ajustar los filtros para encontrar espacios disponibles.
    </p>
  </div>
  }
</div>

<modal-dreservas></modal-dreservas>
