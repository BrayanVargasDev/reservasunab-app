<ng-template #estadoCell let-context>
  @if(context.row.original.id === -1) {
  <span class="badge font-semibold badge-info">Nuevo</span>
  } @else {
  <div
    [attr.data-tip]="context.getValue() === null ? 'Desactivar' : 'Activar'"
    [ngClass]="{
      'badge font-semibold min-w-20 hover:cursor-pointer hover:scale-105 transition-all tooltip align-middle': true,
      'tooltip-right': !context.column.getIsVisible(),
      'tooltip-left': context.column.getIsVisible(),
      'badge-success': context.getValue() === null,
      'badge-error': context.getValue() !== null,
      'opacity-50 pointer-events-none badge-ghost': appService.editando()
    }"
    [attr.disabled]="appService.guardando()"
    (click)="
      authService.tienePermisos('ESP000012')
        ? appService.editando()
          ? null
          : cambiarEstadoConfig(context.row.original)
        : null
    "
  >
    {{ (context.getValue() === null ? 'activo' : 'inactivo') | upperFirst }}
  </div>
  }
</ng-template>

<ng-template #nombreCell let-context>
  @if(context.row.original.id === -1 ||
  configService.filaElementoEditando()[context.row.original.id]) {
  <input
    [formControl]="nombre"
    placeholder="Inserte nombre"
    pattern="[a-zA-Z0-9áéíóú ]*"
    class="input input-sm h-9 placeholder:text-gray-400"
    type="text"
  />
  } @else {
  <span class="font-semibold text-sm md:text-base">{{
    context.getValue()
  }}</span>
  }
</ng-template>

<ng-template #cantidadCell let-context>
  @if(context.row.original.id === -1 ||
  configService.filaElementoEditando()[context.row.original.id]) {
  <input
    [formControl]="cantidad"
    placeholder="Inserte cantidad"
    class="input input-sm h-9 placeholder:text-gray-400"
    step="1"
    type="number"
  />
  } @else {
  <span class="font-semibold text-sm md:text-base">{{
    context.getValue()
  }}</span>
  }
</ng-template>

<ng-template #espacioCell let-context>
  @if(context.row.original.id === -1 ||
  configService.filaElementoEditando()[context.row.original.id]) {
  <select
    [formControl]="espacio"
    class="select input-sm h-9 placeholder:text-gray-400"
  >
    <option [value]="0" disabled selected>Seleccione</option>
    @for(espacio of appService.espaciosQuery.data(); track $index) {
    <option [value]="espacio.id">
      {{ espacio.nombre }}
    </option>
    }
  </select>
  } @else {
  <span class="text-sm md:text-base">
    {{ obtenerEspacioSelect(context.row.original.id_espacio) }}
  </span>
  }
</ng-template>

<ng-template #fechaCell let-context>
  @if (context.row.original.id === -1 ||
  configService.filaElementoEditando()[context.row.original.id]) {
  <span>{{ fechaActual() }}</span>
  } @else {
  <span>
    {{ context.getValue() }}
  </span>
  }
</ng-template>

<table
  responsiveTable
  #tablaElemento="responsiveTable"
  [table]="tablaElementos()"
  class="table w-full rounded-box table-sm sm:table-md"
>
  <thead class="sticky top-0 z-20 bg-base-100">
    @for (headerGroup of tablaElementos().getHeaderGroups(); track
    headerGroup.id) {
    <tr>
      @for (header of headerGroup.headers; track header.id) {
      <th
        class="p-2 text-left first:rounded-tl-md last:rounded-tr-md bg-base-100 z-20"
        [colSpan]="header.colSpan"
      >
        @if (!header.isPlaceholder) {
        <ng-container
          *flexRender="
            header.column.columnDef.header;
            props: header.getContext();
            let header
          "
        >
          <span class="text-left" [innerHTML]="header"></span>
        </ng-container>
        }
      </th>
      }
    </tr>
    }
  </thead>
  <tbody>
    @if (!elementosQuery.length && !modoCreacion()) {
    <tr>
      <td
        [attr.colspan]="
          tablaElementos().getAllColumns().length +
          (tablaElemento.hiddenColumnIds().size > 0 ? 1 : 0)
        "
        class="text-center text-gray-500"
      >
        <span>No hay elementos aún...</span>
      </td>
    </tr>
    } @else { @for (row of tablaElementos().getRowModel().rows; track row.id) {
    <tr class="bg-base-100">
      @for (cell of row.getVisibleCells(); track cell.id) {
      <td class="py-1">
        <ng-container
          *flexRender="
            cell.column.columnDef.cell;
            props: cell.getContext();
            let cell
          "
        >
          <div [innerHTML]="cell"></div>
        </ng-container>
      </td>
      }
    </tr>
    @if (row.getIsExpanded()) {
    <tr class="bg-base-300 border-none">
      <td [attr.colspan]="row.getVisibleCells().length + 1">
        <div class="bg-base-100 rounded-md p-2 md:p-4 shadow-md w-full">
          <h4 class="text-lg font-semibold mb-1 md:mb-4 text-center">
            Configuración del valor por tipo de usuario
          </h4>

          <div
            class="grid w-full grid-cols-[repeat(auto-fit,minmax(11rem,1fr))] gap-2 md:gap-4"
          >
            <!-- Valor Estudiante -->
            <div class="flex flex-col">
              <label
                class="font-bold text-base-content max-sm:text-xs text-sm mb-2"
              >
                Estudiante:
              </label>
              @if (row.original.id === -1 ||
              configService.filaElementoEditando()[row.original.id]) {
              <input
                [formControl]="valorEstudiante"
                class="input input-sm h-9 w-full placeholder:text-gray-400"
                type="number"
                min="0"
                placeholder="Valor"
              />
              } @else {
              <span class="p-2 bg-base-200 rounded">
                {{ row.original.valor_estudiante || 'No definido' }}
              </span>
              }
            </div>
            <!-- Valor Administrativo -->
            <div class="flex flex-col">
              <label
                class="font-bold text-base-content max-sm:text-xs text-sm mb-2"
              >
                Administrativo:
              </label>
              @if (row.original.id === -1 ||
              configService.filaElementoEditando()[row.original.id]) {
              <input
                [formControl]="valorAdministrativo"
                class="input input-sm h-9 w-full placeholder:text-gray-400"
                type="number"
                min="0"
                placeholder="Valor"
              />
              } @else {
              <span class="p-2 bg-base-200 rounded">
                {{ row.original.valor_administrativo || 'No definido' }}
              </span>
              }
            </div>

            <!-- Valor Externo -->
            <div class="flex flex-col">
              <label
                class="font-bold text-base-content max-sm:text-xs text-sm mb-2"
              >
                Externo:
              </label>
              @if (row.original.id === -1 ||
              configService.filaElementoEditando()[row.original.id]) {
              <input
                [formControl]="valorExterno"
                class="input input-sm h-9 w-full placeholder:text-gray-400"
                type="number"
                min="0"
                placeholder="Valor"
              />
              } @else {
              <span class="p-2 bg-base-200 rounded">
                {{ row.original.valor_externo || 'No definido' }}
              </span>
              }
            </div>

            <!-- Valor Egresado -->
            <div class="flex flex-col">
              <label
                class="font-bold text-base-content max-sm:text-xs text-sm mb-2"
              >
                Egresado:
              </label>
              @if (row.original.id === -1 ||
              configService.filaElementoEditando()[row.original.id]) {
              <input
                [formControl]="valorEgresado"
                class="input input-sm h-9 w-full placeholder:text-gray-400"
                type="number"
                min="0"
                placeholder="Valor"
              />
              } @else {
              <span class="p-2 bg-base-200 rounded">
                {{ row.original.valor_egresado || 'No definido' }}
              </span>
              }
            </div>
          </div>

          @if (tablaElemento.hiddenColumnIds().size !== 0) {
          <div class="divider max-md:my-1 my-4"></div>
          <div class="space-y-2">
            <ul>
              @for (col of tablaElementos.getAllLeafColumns(); track $index) {
              @if (tablaElemento.hiddenColumnIds().has(col.id)) {
              <li class="flex my-2 flex-row gap-2 items-center">
                <span class="font-bold text-base-content">
                  {{ col.columnDef.header }}:
                </span>
                <span>
                  <ng-container
                    *flexRender="
                      tablaElemento.getCell(col, row).column.columnDef.cell;
                      props: tablaElemento.getCell(col, row).getContext();
                      let cell
                    "
                  >
                    <div [innerHTML]="cell"></div>
                  </ng-container>
                </span>
              </li>
              } }
            </ul>
          </div>
          }
        </div>
      </td>
    </tr>
    } } }
  </tbody>
</table>

<app-paginador
  [ngClass]="
    'flex flex-col sm:flex-row items-center justify-between gap-4 p-4 bg-base-100 sticky bottom-0 z-10 rounded-b-box'
  "
  [estado]="configService.paginacionCategorias()"
  [paginacion]="configService.datosPaginadorCategorias() ?? null"
  (cambioPaginacion)="onPageChange($event)"
  [mostrarInfo]="true"
  [mostrarSelectorTamano]="true"
  [mostrarExtremos]="true"
  [deshabilitado]="configService.categoriasQuery.isFetching()"
  (prefetchFunction)="configService.prefetchCategorias($event)"
>
</app-paginador>

<!-- Paginador -->

<ng-template #alertaRoles></ng-template>
