@if (!appService.esMovil()) {
<ng-template #ionChip let-context>
  <ion-chip
    [color]="context.getValue() === 'Activo' ? 'success' : 'danger'"
    [outline]="true"
    (click)="cambiarEstadoUsuario(context.row.original)"
    class="cursor-pointer"
  >
    {{ context.getValue() }}
  </ion-chip>
</ng-template>

<ng-template #chipWeb let-context>
  <div
    [attr.data-tip]="context.getValue() === 'Activo' ? 'Desactivar' : 'Activar'"
    [ngClass]="{
        'badge badge-outline min-w-20 hover:cursor-pointer hover:scale-105 transition-all tooltip align-middle': true,
        'badge-success': context.getValue() === 'Activo',
        'badge-error': context.getValue() === 'Inactivo',
    }"
    (click)="
      context.getValue() === 'Activo'
        ? eliminarUsuario(context.row.original)
        : activarUsuario(context.row.original)
    "
  >
    {{ context.getValue() }}
  </div>
</ng-template>

<ng-template #celdaNombre let-context>
  <div class="flex w-full h-full items-center justify-between">
    <span class="min-w-20">{{ context.getValue() }}</span>
    <button
      class="btn btn-soft btn-accent w-8 h-8 rounded-box btn-sm lg:tooltip p-0"
      (click)="editarUsuario(context.row.original)"
      data-tip="Editar usuario"
    >
      <app-web-icon estilos="h-4 w-4" nombreIcono="open-outline"></app-web-icon>
    </button>
  </div>
</ng-template>

<ng-template #celdaRol let-context>
  <div class="flex w-full h-full items-center justify-between">
    <span class="capitalize">{{ context.getValue() }}</span>
    <div class="dropdown lg:dropdown-left">
      <button
        role="button"
        tabindex="0"
        class="btn btn-soft btn-secondary w-8 h-8 rounded-box btn-sm lg:tooltip lg:tooltip-left p-0"
        data-tip="Cambiar rol"
      >
        <app-web-icon
          estilos="h-4 w-4"
          nombreIcono="caret-down-outline"
        ></app-web-icon>
      </button>
      <ul
        tabindex="0"
        class="dropdown-content menu bg-base-100 rounded-box z-1 w-52 p-2 shadow-sm"
        style="position-anchor: --anchor-1"
      >
        @for (rol of rolesQuery; track $index) {
        <li>
          <button
            type="button"
            class="w-full text-left"
            (click)="cambiarRolUsuario(context.row.original, rol.nombre!)"
          >
            {{ rol.nombre | titlecase }}
          </button>
        </li>
        }
      </ul>
    </div>
  </div>
</ng-template>

<div
  class="flex flex-col md:flex-row md:mt-2 md:pr-2 w-full pb-2 md:pb-4 items-stretch justify-center md:justify-between sticky top-0 z-10 bg-base-300"
>
  <div class="flex items-center">
    <h2 class="font-bold text-4xl">Usuarios</h2>
  </div>
  <div class="flex flex-col md:flex-row gap-2">
    <input
      type="text"
      placeholder="Buscar por nombre, email o rol..."
      class="input input-bordered input-primary w-full h-11 rounded-box md:max-w-xs placeholder:text-gray-500 placeholder:text-sm"
      [(ngModel)]="filtroTexto"
      (input)="aplicarFiltro()"
    />
    <button (click)="crearUsuario()" class="btn btn-primary h-11 rounded-box">
      <app-web-icon estilos="h-6 w-6" nombreIcono="add-outline"></app-web-icon>
      Nuevo Usuario
    </button>
  </div>
</div>

@if (usuariosQuery.isPending()) {
<div class="flex justify-center items-center py-8">
  <span class="loading loading-spinner loading-lg text-primary"></span>
  <span class="ml-2 text-base-content">Cargando usuarios...</span>
</div>
} @else if (usuariosQuery.isError()) {
<div class="alert alert-error mb-4">
  <app-web-icon
    estilos="h-6 w-6"
    nombreIcono="alert-circle-outline"
  ></app-web-icon>
  <span>Error al cargar los usuarios. </span>
  <button class="btn btn-sm btn-outline" (click)="refrescarDatos()">
    Reintentar
  </button>
</div>
} @else {
<table
  responsiveTable
  #responsiveWeb="responsiveTable"
  [table]="table()"
  [ngClass]="{
    'table rounded-none table-sm sm:table-md rounded-t-box bg-base-100 w-full overflow-y-auto': true,
    'rounded-b-box':
      !usuariosQuery.isPending() && !usuariosQuery.isError()
        ? usuariosQuery.data()!.length > 10
        : false
  }"
>
  <thead>
    @for (headerGroup of table.getHeaderGroups(); track headerGroup.id) {
    <tr>
      @if (responsiveWeb.hiddenColumnIds().size !== 0) {
      <th></th>
      } @for (header of headerGroup.headers; track header.id) { @if
      (!header.isPlaceholder) {
      <th
        [class]="header.column.columnDef.meta?.className || ''"
        [style.width]="header.getSize()"
      >
        <ng-container
          *flexRender="
            header.column.columnDef.header;
            props: header.getContext();
            let header
          "
        >
          <div [innerHTML]="header"></div>
        </ng-container>
      </th>
      } }
    </tr>
    }
  </thead>
  <tbody>
    @if (!usuariosQuery.data()) {
    <tr>
      <td [attr.colspan]="columnas().length" class="text-center">
        No se encontraron resultados.
      </td>
    </tr>
    } @else { @for (row of table().getCoreRowModel().rows; track row.id) {
    <tr
      [ngClass]="{
        'hover:bg-base-200': true,
        'last:rounded-b-none': true,
        'bg-base-200': isRowExpanded(+row.id)
      }"
      [class.expanded]="isRowExpanded(+row.id)"
    >
      @if (responsiveWeb.hiddenColumnIds().size !== 0) {
      <td class="!pe-0">
        <app-table-expansor
          [isExpanded]="isRowExpanded(+row.id)"
          (toggleExpand)="row.toggleExpanded()"
        ></app-table-expansor>
      </td>
      } @for (cell of row.getVisibleCells(); track cell.id) {
      <td>
        <ng-container
          *flexRender="
            cell.column.columnDef.cell;
            props: cell.getContext();
            let cell
          "
        >
          <span [innerHTML]="cell"></span>
        </ng-container>
      </td>
      }
    </tr>

    @if (isRowExpanded(+row.id) && responsiveWeb.hiddenColumnIds().size !== 0) {
    <tr class="bg-base-300 border-none">
      <td [attr.colspan]="row.getVisibleCells().length + 1">
        @if (responsiveWeb.hiddenColumnIds().size !== 0) {
        <ul class="bg-base-100 rounded-box px-4 py-1 shadow-sm">
          @for (col of table.getAllLeafColumns(); track $index) { @if
          (responsiveWeb.hiddenColumnIds().has(col.id)) {
          <li class="flex my-2 flex-row gap-2 items-center">
            <span class="font-bold text-base-content">
              {{ col.columnDef.header }}:
            </span>
            <span>
              <ng-container
                *flexRender="
                  responsiveWeb.getCell(col, row).column.columnDef.cell;
                  props: responsiveWeb.getCell(col, row).getContext();
                  let cell
                "
              >
                <div [innerHTML]="cell"></div>
              </ng-container>
            </span>
          </li>
          } }
        </ul>
        }
      </td>
    </tr>
    } } }
  </tbody>
</table>

<!-- Paginador -->
<app-paginador
  [ngClass]="
    'flex flex-col sm:flex-row items-center justify-between gap-4 p-4 bg-base-100 sticky bottom-0 z-10 rounded-b-box'
  "
  [estado]="usuariosService.paginacion()"
  [paginacion]="usuariosService.datosPaginador() ?? null"
  (cambioPaginacion)="onPageChange($event)"
  [mostrarInfo]="true"
  [mostrarSelectorTamano]="true"
  [mostrarExtremos]="true"
  [deshabilitado]="usuariosQuery.isFetching()"
>
</app-paginador>

<ng-template #alertaUsuarios></ng-template>

<usuarios-gestion-modal
  (guardadoExitoso)="usuarioGuardadoExitoso($event)"
></usuarios-gestion-modal>
} }
