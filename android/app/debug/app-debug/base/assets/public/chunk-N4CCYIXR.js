import{A as S,C as I,G as c}from"./chunk-YPFPCNBD.js";import{D as u,H as l,Rb as T,U as h,bc as E,d as _,k as n,pb as m}from"./chunk-U6U25BWF.js";import{f as d,j as a}from"./chunk-LVXXLD6S.js";var g=`${c.apiUrl}/usuarios`,A=o=>n(o.get(`${g}/terminos-condiciones`)),D=o=>n(o.post(`${g}/terminos-condiciones`,{})),y=o=>n(o.get(`${g}/perfil-completo`));var P=c.apiUrl,k=(o,r)=>n(o.get(`${P}/check-status`,{params:{refreshToken:r||""}}));var V=c.apiUrl,R=o=>n(o.get(`${V}/me`));var F=c.apiUrl;function U(o,r){return a(this,null,function*(){return n(o.post(`${F}/intercambiar`,{codigo:r}))})}var $=c.apiUrl,O=o=>n(o.post(`${$}/logout`,{}));var K=c.apiUrl;function L(o,r){return a(this,null,function*(){return n(o.post(`${K}/ingresar`,r))})}var ht=c.apiUrl;var H=c.apiUrl;function w(o,r){return a(this,null,function*(){return n(o.post(`${H}/registrar`,r))})}var i={TOKEN:"access_token",REFRESH_TOKEN:"refresh_token",USER:"user",LAST_ACTIVITY:"last_activity",PROFILE_COMPLETED:"profile_completed",TERMS_ACCEPTED:"terms_accepted"},C={TOKEN_CHECK_TIMEOUT:5e3,GUARD_TIMEOUT:3e3,CACHE_DURATION:1e3*60*5};var v=(()=>{let r=class r{constructor(){this.changes$=new _(null),window.addEventListener("storage",t=>{t.key&&t.storageArea===localStorage&&this.changes$.next({key:t.key,oldValue:t.oldValue,newValue:t.newValue})})}getItem(t){try{return localStorage.getItem(t)}catch(e){return console.error("Error reading from localStorage:",e),null}}setItem(t,e){try{let s=this.getItem(t);localStorage.setItem(t,e),this.changes$.next({key:t,oldValue:s,newValue:e})}catch(s){console.error("Error writing to localStorage:",s)}}removeItem(t){try{let e=this.getItem(t);localStorage.removeItem(t),this.changes$.next({key:t,oldValue:e,newValue:null})}catch(e){console.error("Error removing from localStorage:",e)}}getJSON(t){let e=this.getItem(t);if(!e)return null;try{return JSON.parse(e)}catch(s){return console.error("Error parsing JSON from localStorage:",s),null}}setJSON(t,e){try{this.setItem(t,JSON.stringify(e))}catch(s){console.error("Error serializing JSON to localStorage:",s)}}get changes(){return this.changes$.asObservable()}onChange(t,e){return this.changes.subscribe(s=>{s&&s.key===t&&e(s)})}};r.\u0275fac=function(e){return new(e||r)},r.\u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"});let o=r;return o})();var b=(()=>{let r=class r{constructor(){this._isLoading=h(!1),this._title=h("Cargando..."),this._message=h("Por favor espera mientras procesamos tu informaci\xF3n"),this.isLoading=this._isLoading.asReadonly(),this.title=this._title.asReadonly(),this.message=this._message.asReadonly()}show(t,e){t&&this._title.set(t),e&&this._message.set(e),this._isLoading.set(!0)}hide(){this._isLoading.set(!1)}updateText(t,e){this._title.set(t),e&&this._message.set(e)}};r.\u0275fac=function(e){return new(e||r)},r.\u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"});let o=r;return o})();var Ht=(()=>{let r=class r{constructor(){this.http=l(T),this.qc=l(S),this.router=l(E),this.globalLoader=l(b),this.storage=l(v),this._estadoAutenticacion=h("loading"),this._usuario=h(null),this._accessToken=h(localStorage.getItem(i.TOKEN)),this._isLoading=h(!1),this._lastActivityMs=null,this._hasRefreshToken=!1,this._currentUrl=h(""),this.estadoAutenticacion=m(()=>this._usuario()?"authenticated":"unauthenticated"),this.usuario=m(()=>this._usuario()),this.token=m(()=>this._accessToken()),this.estaAutenticado=m(()=>this.estadoAutenticacion()==="authenticated"),this.esRutaPublica=m(()=>{let t=this._currentUrl();return["/auth/login","/auth/registro","/auth/reset-password","/acceso-denegado","/404","/pagos/reservas"].some(s=>t.includes(s))}),this.userQuery=I(()=>({queryKey:["user"],queryFn:()=>R(this.http),retry:0,enabled:this.isSessionValid()&&!this.esRutaPublica(),staleTime:C.CACHE_DURATION,select:t=>{let e=t.data;return e&&(this.guardarUsuarioStorage(e),this._usuario.set(e),this._estadoAutenticacion.set("authenticated")),e||null},onError:t=>{}})),this.loadFromStorage()}onSuccessLogin(t){this.storage.setItem(i.TOKEN,t.access_token||""),this.storage.setItem(i.REFRESH_TOKEN,t.refresh_token||""),this.storage.setItem(i.USER,JSON.stringify(t)),this.storage.setItem(i.LAST_ACTIVITY,t.token_expires_at||""),this._usuario.set(t),this._accessToken.set(t.access_token||null),this._hasRefreshToken=!!t.refresh_token,this._estadoAutenticacion.set("authenticated")}setLoading(t){this._isLoading.set(t)}setToken(t){this._accessToken.set(t)}get isLoading(){return this._isLoading()}login(t,e){return a(this,null,function*(){try{let{data:s,status:f,message:p}=yield L(this.http,{email:t,password:e});if(f!=="success")throw new Error(p);return this.onSuccessLogin(s),this.globalLoader.show("Iniciando sesi\xF3n","Verificando t\xE9rminos y condiciones..."),!0}catch(s){throw s}})}logout(t=!1){return a(this,null,function*(){yield O(this.http),this.clearSession(t),window.location.href="/auth/login"})}clearSession(t=!1){this.storage.removeItem(i.TOKEN),this.storage.removeItem(i.USER),t&&(this.storage.removeItem(i.PROFILE_COMPLETED),this.storage.removeItem(i.TERMS_ACCEPTED),this.storage.removeItem(i.REFRESH_TOKEN),this.storage.removeItem(i.LAST_ACTIVITY)),this._accessToken.set(null),this._estadoAutenticacion.set("unauthenticated"),this.qc.setQueryData(["user"],null),this.qc.removeQueries({queryKey:["user"]})}isAuthenticated(){return this.estadoAutenticacion()==="authenticated"}getToken(){return this._accessToken()}setUser(t){this._usuario.set(t)}registro(t){return w(this.http,t)}loadFromStorage(){return a(this,null,function*(){try{let t=this.storage.getItem(i.REFRESH_TOKEN),e=this.storage.getJSON(i.USER),s=this.storage.getItem(i.LAST_ACTIVITY);s&&(this._lastActivityMs=parseInt(s)),t&&e?(this._hasRefreshToken=!0,this._usuario.set(e),this._estadoAutenticacion.set("authenticated")):(this._hasRefreshToken=!!t,this._estadoAutenticacion.set("unauthenticated"))}catch{this._hasRefreshToken=!1,this._estadoAutenticacion.set("unauthenticated")}})}guardarUsuarioStorage(t){let p=t,{access_token:e,refresh_token:s}=p,f=d(p,["access_token","refresh_token"]);try{this.storage.setItem(i.USER,JSON.stringify(f))}catch(N){console.error("Error guardando usuario en localStorage:",N)}}obtenerUsuarioStorage(){return JSON.parse(this.storage.getItem(i.USER)||"null")}tienePermisos(t){let e=this._usuario();return!e||!e.permisos?!1:e.rol?.nombre?.toLowerCase()==="administrador"?!0:e.permisos.some(s=>s.codigo===t)}isSessionValid(){try{return!(!(this._usuario()||this.obtenerUsuarioStorage())||!this._hasRefreshToken)}catch(t){return console.error("Error validando sesi\xF3n:",t),!1}}checkTerminosAceptados(){return a(this,null,function*(){try{let e=(yield A(this.http)).data.terminos_condiciones;return e&&this.globalLoader.updateText("T\xE9rminos y condiciones aceptados","Verificando datos de perfil..."),e}catch{return!1}})}checkPerfilCompletado(){return a(this,null,function*(){try{let e=(yield y(this.http)).data.perfil_completo;return e&&this.globalLoader.updateText("Perfil completo","Cargando configuraci\xF3n..."),e}catch{return!1}})}intercambiarToken(t){return a(this,null,function*(){try{let e=yield U(this.http,t),s=e.data;if(e.status!=="success"||!s)throw new Error("Error intercambiando token");return this.onSuccessLogin(s),!0}catch{return!1}})}validarTerminosYPerfil(){return a(this,null,function*(){try{return(yield this.checkTerminosAceptados())?(yield this.checkPerfilCompletado())?"/":"/perfil":"/auth/terms-conditions"}catch{return"/"}})}checkStatus(){return a(this,null,function*(){let t=this.storage.getItem(i.REFRESH_TOKEN);t||this.logout();try{let{data:e,status:s,message:f}=yield k(this.http,t);if(s!=="success")throw new Error("Ocurri\xF3 un error al validar la sesi\xF3n: "+f);this.onSuccessLogin(e)}catch(e){console.error(e),this.logout(!0)}})}ngOnDestroy(){}};r.\u0275fac=function(e){return new(e||r)},r.\u0275prov=u({token:r,factory:r.\u0275fac,providedIn:"root"});let o=r;return o})();export{D as a,y as b,i as c,v as d,b as e,Ht as f};
