import{i as w}from"./chunk-AV73RGVI.js";import{f as g}from"./chunk-N4CCYIXR.js";import{D as S,H as n,U as h,bc as E}from"./chunk-U6U25BWF.js";import{a as O,b as _}from"./chunk-AUJJZC6I.js";import{j as s}from"./chunk-LVXXLD6S.js";var v=(e=>(e[e.TOP=0]="TOP",e[e.BOTTOM=1]="BOTTOM",e))(v||{}),p=(e=>(e[e.PAGE_SHEET=0]="PAGE_SHEET",e[e.FORM_SHEET=1]="FORM_SHEET",e[e.FULL_SCREEN=2]="FULL_SCREEN",e))(p||{}),f=(e=>(e[e.BOTTOM_SHEET=0]="BOTTOM_SHEET",e[e.FULL_SCREEN=1]="FULL_SCREEN",e))(f||{}),m=(e=>(e[e.FLIP_HORIZONTAL=0]="FLIP_HORIZONTAL",e[e.CROSS_DISSOLVE=1]="CROSS_DISSOLVE",e[e.COVER_VERTICAL=2]="COVER_VERTICAL",e))(m||{}),d=(e=>(e[e.FADE_IN=0]="FADE_IN",e[e.FADE_OUT=1]="FADE_OUT",e[e.SLIDE_IN_LEFT=2]="SLIDE_IN_LEFT",e[e.SLIDE_OUT_RIGHT=3]="SLIDE_OUT_RIGHT",e))(d||{}),b=(e=>(e[e.CLOSE=0]="CLOSE",e[e.CANCEL=1]="CANCEL",e[e.DONE=2]="DONE",e))(b||{}),A={allowZoom:!1,hardwareBack:!0,pauseMedia:!0},C={allowOverScroll:!0,enableViewportScale:!1,allowInLineMediaPlayback:!1,surpressIncrementalRendering:!1,viewStyle:p.FULL_SCREEN,animationEffect:m.COVER_VERTICAL,allowsBackForwardNavigationGestures:!0},N={showToolbar:!0,showURL:!0,clearCache:!0,clearSessionCache:!0,mediaPlaybackRequiresUserAction:!1,closeButtonText:"Close",toolbarPosition:v.TOP,showNavigationButtons:!0,leftToRight:!1,customWebViewUserAgent:null,android:A,iOS:C},R={closeButtonText:b.DONE,viewStyle:p.FULL_SCREEN,animationEffect:m.COVER_VERTICAL,enableBarsCollapsing:!0,enableReadersMode:!1},I={showTitle:!1,hideToolbarOnScroll:!1,viewStyle:f.BOTTOM_SHEET,startAnimation:d.FADE_IN,exitAnimation:d.FADE_OUT},T={android:I,iOS:R},c=_("InAppBrowser",{web:()=>import("./chunk-22W3ZFKN.js").then(e=>new e.InAppBrowserWeb)});var q=(()=>{let i=class i{constructor(){this.router=n(E),this.authService=n(g),this.appService=n(w),this._browser=h(null),this.isAuthenticating=!1,this.browserClosed=h(!1),this._browser.set(c)}loginWithSaml(){return s(this,null,function*(){if(!O.isNativePlatform())throw new Error("Este m\xE9todo solo funciona en plataformas nativas");if(this.isAuthenticating){console.warn("Ya hay una autenticaci\xF3n en progreso");return}try{this.isAuthenticating=!0,this.browserClosed.set(!1),this.authService.setLoading(!0);let r=`${this.appService.samlUrl}/api/saml/${this.appService.tenantId}/login`;if(!r||!this.appService.samlUrl||!this.appService.tenantId)throw new Error("Configuraci\xF3n de SSO incompleta");this.authService.clearSession(),yield this._browser()?.openInSystemBrowser({url:r,options:T}),yield this._browser()?.addListener("browserClosed",()=>{this.browserClosed.set(!0)})}catch(r){throw console.error("Error iniciando autenticaci\xF3n m\xF3vil:",r),this.isAuthenticating=!1,this.authService.setLoading(!1),r}})}getBrowser(){return this._browser()}closeBrowser(){return s(this,null,function*(){this.browserClosed()||(yield this.getBrowser()?.close(),this.browserClosed.set(!0))})}isCallbackUrl(r){try{return new URL(r).pathname==="/auth/callback"}catch{return!1}}handleCallbackNavigation(r){return s(this,null,function*(){try{let t=new URL(r),l=t.searchParams.get("code"),a=t.searchParams.get("error"),u=t.searchParams.get("error_description"),o=t.searchParams.get("returnUrl");yield c.close(),this.cleanup(),this.router.navigate(["/auth/callback"],{queryParams:{code:l,error:a,error_description:u,returnUrl:o}})}catch(t){console.error("Error procesando callback:",t),this.cleanup(),this.router.navigate(["/auth/login"],{queryParams:{sso_error:"unexpected_error",sso_error_description:"Error procesando autenticaci\xF3n m\xF3vil"}})}})}processCallback(r,t,l,a){return s(this,null,function*(){try{if(t){console.error("OAuth error en m\xF3vil:",t,l),this.router.navigate(["/auth/login"],{queryParams:{sso_error:t,sso_error_description:l||"Error en autenticaci\xF3n SSO m\xF3vil"}});return}if(!r||r.trim()===""){console.error("No authorization code received en m\xF3vil"),this.router.navigate(["/auth/login"],{queryParams:{sso_error:"no_code",sso_error_description:"No se recibi\xF3 c\xF3digo de autorizaci\xF3n"}});return}if(console.debug("Procesando c\xF3digo de autorizaci\xF3n en m\xF3vil:",r.substring(0,10)+"..."),!(yield this.authService.intercambiarToken(r))){console.error("Token exchange failed en m\xF3vil"),this.authService.setLoading(!1),this.router.navigate(["/auth/login"],{queryParams:{sso_error:"token_exchange_failed",sso_error_description:"Error al intercambiar tokens"},replaceUrl:!0});return}console.debug("Token intercambiado correctamente en m\xF3vil, redirigiendo...");let o=yield this.authService.validarTerminosYPerfil();if(o&&o!=="/")console.debug("Redirecting to post-login destination:",o),this.router.navigate([o]);else if(a&&a!=="/")console.debug("Redirecting to return URL:",a),this.router.navigate([a],{replaceUrl:!0});else{console.debug("Redirecting to first available page");let{NavigationService:L}=yield import("./chunk-UCESGNQ3.js");n(L).navegarAPrimeraPaginaDisponible()}}catch(u){console.error("Error en proceso de callback m\xF3vil:",u),this.router.navigate(["/auth/login"],{queryParams:{sso_error:"unexpected_error",sso_error_description:"Error inesperado en autenticaci\xF3n m\xF3vil"}})}finally{this.isAuthenticating=!1,this.authService.setLoading(!1)}})}cleanup(){this.isAuthenticating=!1,this.authService.setLoading(!1);try{c.removeAllListeners()}catch{}}cancelAuthentication(){return s(this,null,function*(){this.isAuthenticating&&(yield c.close(),this.cleanup())})}};i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=S({token:i,factory:i.\u0275fac,providedIn:"root"});let e=i;return e})();export{q as a};
