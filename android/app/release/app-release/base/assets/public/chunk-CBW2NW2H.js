import{a as se}from"./chunk-I7IWUYYH.js";import{a as Qe,b as Ne,c as qe,d as Le,f as X,g as He,h as Ge,i as Ue,j as Ke,k as Be}from"./chunk-KWYFY7T2.js";import{a as je}from"./chunk-ZU7Q4APP.js";import{b as re}from"./chunk-KTGXZBKE.js";import"./chunk-LKADUWP6.js";import"./chunk-6CQPCFUJ.js";import{a as ke,b as Ve,j as ze,l as De,u as $e}from"./chunk-MBZLMIXQ.js";import"./chunk-XPPSGRKL.js";import{d as Oe,h as D}from"./chunk-4HN4PAFJ.js";import{a as Me,b as Fe,c as ae,d as Ie,e as Ae,i as M}from"./chunk-AV73RGVI.js";import{f as J}from"./chunk-N4CCYIXR.js";import{F as we}from"./chunk-UAEYNMJW.js";import{A as Te,C as Ee,c as be,e as G,g as ve,j as ne,m as Se,w as Re,y as Pe,z as ye}from"./chunk-YPFPCNBD.js";import{Aa as w,Ba as _,Ca as s,D as me,Da as d,Db as Z,Ea as b,Fa as K,Ga as B,H as g,Ia as y,Ja as T,Ka as c,Lb as z,N as R,O as P,R as ue,Ra as Q,Rb as Ce,Sa as he,Ta as N,U as h,Xa as f,Ya as q,Za as A,aa as U,c as ee,cb as oe,da as l,ha as te,ia as k,lb as L,na as V,pb as v,qb as fe,rb as ge,sb as W,ta as ie,tb as H,u as ce,v as de,va as x,wa as C,wb as xe,xa as _e,z as pe,za as E}from"./chunk-U6U25BWF.js";import"./chunk-B3LSNZRN.js";import"./chunk-WUBXWBRT.js";import"./chunk-B52GHH4C.js";import"./chunk-KZ3CI6ZI.js";import"./chunk-HC6MZPB3.js";import"./chunk-SV2ZKNWA.js";import"./chunk-IA5KSSRM.js";import"./chunk-RS5W3JWO.js";import"./chunk-XENCGOZ2.js";import"./chunk-XZRAAXKF.js";import"./chunk-7D6K5XYM.js";import"./chunk-OBXDPQ3V.js";import"./chunk-QY5CJPR3.js";import"./chunk-MCRJI3T3.js";import"./chunk-ZD4SBDZ6.js";import"./chunk-NCLOD2DI.js";import"./chunk-UYQ7EZNZ.js";import"./chunk-BAKMWPBW.js";import"./chunk-AESNPOCP.js";import"./chunk-H3ZVKW6B.js";import"./chunk-HMK4XMX7.js";import"./chunk-E7UUDSES.js";import"./chunk-JQ3FRJ6A.js";import"./chunk-3IVKBF6N.js";import"./chunk-NMYJD6OP.js";import"./chunk-C5RQ2IC2.js";import"./chunk-SV7S5NYR.js";import{a as m,b as u,j as O}from"./chunk-LVXXLD6S.js";var $=(()=>{let n=class n{constructor(){this.http=g(Ce),this.appService=g(M),this.queryClient=g(Te),this._appService=g(M),this._estadoModal=h({titulo:"",edicion:!1}),this._modoCreacion=h(!1),this._filaPermisosEditando=h({}),this._pantallaSeleccionada=h(null),this._permisosSeleccionados=h({}),this._permisosNuevoRol=h([]),this._permisosUsuarioEditando=h({}),this._paginacion=h({pageIndex:0,pageSize:10}),this._datosPaginador=h(null),this._filtroTexto=h(""),this._modoCreacionRol=h(!1),this._filaRolEditando=h({}),this._paginacionRoles=h({pageIndex:0,pageSize:10}),this._datosPaginadorRoles=h(null),this.modoCreacionRol=v(()=>this._modoCreacionRol()),this.filaRolEditando=v(()=>this._filaRolEditando()),this.paginacionRoles=v(()=>this._paginacionRoles()),this.datosPaginadorRoles=v(()=>this._datosPaginadorRoles()),this.pantallaSeleccionada=v(()=>this._pantallaSeleccionada()),this.filtroTexto=v(()=>this._filtroTexto()),this.permisosSeleccionados=v(()=>this._permisosSeleccionados()),this.permisosNuevoRol=v(()=>this._permisosNuevoRol()),this.permisosUsuarioEditando=v(()=>this._permisosUsuarioEditando()),this._pestana=h("rol"),this.pestana=v(()=>this._pestana()),this.permisosQuery=[],this.rolesPermisosQuery=Ee(()=>({queryKey:["roles-permisos",this.paginacionRoles()],queryFn:()=>Ie(this.http,m({},this.paginacionRoles())),select:e=>(this._datosPaginadorRoles.set(e.meta),e.data)}))}setPestana(e){this._pestana.set(e)}setEstadoModal(e,i){this._estadoModal.set({titulo:e,edicion:i})}setModoCreacion(e){this._modoCreacion.set(e)}setEditandoFilaPermisos(e,i){this._filaPermisosEditando.set(u(m({},this._filaPermisosEditando()),{[e]:i}))}setPantallaSeleccionada(e){this._pantallaSeleccionada.set(e)}setPaginacion(e){this._paginacion.set(e)}setFiltroTexto(e){this._filtroTexto.set(e),this.setPaginacion(u(m({},this._paginacion()),{pageIndex:0}))}limpiarFiltro(){this._filtroTexto.set("")}resetFilaPermisosEditando(){this._filaPermisosEditando.set({})}prefetchPermisos(e){this.queryClient.prefetchQuery({queryKey:["permisos",e,this._filtroTexto()],queryFn:()=>ae(this.http,u(m({},e),{search:this._filtroTexto()})),staleTime:1e3*60*5})}prefetchRoles(e){this.queryClient.prefetchQuery({queryKey:["roles-permisos",e,this._filtroTexto()],queryFn:()=>ae(this.http,u(m({},e),{search:this._filtroTexto()})),staleTime:1e3*60*5})}setPermisosSeleccionados(e,i){this._permisosSeleccionados.update(a=>u(m({},a),{[e]:[...i]}))}getPermisosSeleccionados(e){return this._permisosSeleccionados()[e]||[]}setPermisosNuevoRol(e){this._permisosNuevoRol.set([...e])}limpiarPermisosSeleccionados(e){this._permisosSeleccionados.update(i=>{let a=m({},i);return delete a[e],a})}resetPermisosSeleccionados(){this._permisosSeleccionados.set({}),this._permisosNuevoRol.set([]),this._permisosUsuarioEditando.set({})}setPermisosUsuarioEditando(e,i){let a=-Math.abs(e);this._permisosSeleccionados.update(p=>u(m({},p),{[a]:[...i]}))}getPermisosUsuarioEditando(e){let i=-Math.abs(e);return this._permisosSeleccionados()[i]||[]}limpiarPermisosUsuarioEditando(e){let i=-Math.abs(e);this._permisosSeleccionados.update(a=>{let p=m({},a);return delete p[i],p})}actualizarPermisosUsuarioAsync(e,i){return O(this,null,function*(){return Ae(this.http,e,i)})}crearRolAsync(e){return O(this,null,function*(){return Me(this.http,e)})}actualizarRolAsync(e,i){return O(this,null,function*(){return Fe(this.http,e,i)})}resetAllexceptPaginacion(){this._modoCreacionRol.set(!1),this._filaRolEditando.set({}),this._pantallaSeleccionada.set(null),this._permisosSeleccionados.set({}),this._permisosNuevoRol.set([]),this._paginacionRoles.set({pageIndex:0,pageSize:10}),this._datosPaginadorRoles.set(null)}setPaginacionRoles(e){this._paginacionRoles.set(e)}setModoCreacionRol(e){this._modoCreacionRol.set(e)}setEditandoFilaRol(e,i){this._filaRolEditando.set(u(m({},this._filaRolEditando()),{[e]:i}))}iniciarCrearRol(){this.setModoCreacionRol(!0),this.setEditandoFilaRol(0,!0),this.setPestana("rol")}};n.\u0275fac=function(i){return new(i||n)},n.\u0275prov=me({token:n,factory:n.\u0275fac,providedIn:"root"});let t=n;return t})();var Je=(t,n)=>n.id_permiso;function Xe(t,n){if(t&1){let o=y();s(0,"div",2)(1,"div",3)(2,"div")(3,"p",4),f(4),d()()(),s(5,"label",5)(6,"input",6),T("change",function(i){let a=R(o).$implicit,p=c(2);return P(p.onPermisoToggle(a,i))}),d()()()}if(t&2){let o=n.$implicit,e=c(2);l(4),A(" ",o.descripcion," "),l(2),_("disabled",e.disabled())("checked",e.permisoActivo(o))}}function Ye(t,n){if(t&1&&(s(0,"div",0),E(1,Xe,7,3,"div",2,Je),d()),t&2){let o=c();l(),w(o.permisos())}}function et(t,n){if(t&1&&(s(0,"div",1),b(1,"app-web-icon",7),s(2,"p",8),f(3),d()()),t&2){let o=c();l(3),A(" ",o.permisosService.pantallaSeleccionada()?"No hay permisos disponibles para esta pantalla.":"Seleccione una pantalla para ver sus permisos."," ")}}var We=(()=>{let n=class n{constructor(){this.permisosService=g($),this.appService=g(M),this.permisos=W.required(),this.permisosActivos=W([]),this.disabled=W(!0),this.permisoToggle=ge()}permisoActivo(e){return e.concedido||!1}onPermisoToggle(e,i){let a=i.target;this.permisoToggle.emit({permiso:e,activo:a.checked})}};n.\u0275fac=function(i){return new(i||n)},n.\u0275cmp=k({type:n,selectors:[["lista-permisos-pantalla"]],inputs:{permisos:[1,"permisos"],permisosActivos:[1,"permisosActivos"],disabled:[1,"disabled"]},outputs:{permisoToggle:"permisoToggle"},decls:2,vars:1,consts:[[1,"grid","grid-cols-1","md:grid-cols-2","gap-2","overflow-y-auto","max-h-full"],[1,"text-center","py-8","w-full"],[1,"flex","items-center","justify-between","gap-2","p-3","bg-base-200","rounded-lg","hover:bg-base-300","transition-colors"],[1,"flex","items-center","gap-2"],[1,"text-xs","md:text-sm","text-base-content"],[1,"cursor-pointer","label"],["type","checkbox",1,"checkbox","checkbox-primary","checkbox-sm",3,"change","disabled","checked"],["nombreIcono","information-circle-outline","estilos","h-12 w-12 mx-auto mb-2 text-base-content/50"],[1,"text-base-content/70"]],template:function(i,a){i&1&&x(0,Ye,3,0,"div",0)(1,et,4,1,"div",1),i&2&&C(a.permisos().length>0?0:1)},dependencies:[z,D],encapsulation:2,changeDetection:0});let t=n;return t})();var it=["alertaRoles"],ot=["nombreCell"],nt=["fechaCell"],at=["descripcionCell"],rt=t=>({"flex justify-between items-center font-semibold px-2 h-[2.75rem] md:h-[3.125rem] md:px-3 cursor-pointer btn btn-secondary btn-soft grow md:w-[12rem] group":!0,"btn-active":t}),st=t=>({"flex w-full items-center gap-1 md:gap-2 justify-between":!0,"btn-active":t}),Y=(t,n)=>n.id,lt=(t,n)=>n.id_pantalla;function ct(t,n){if(t&1&&b(0,"input",8),t&2){let o=c(2);_("formControl",o.nombre)}}function dt(t,n){if(t&1&&(s(0,"span",9),f(1),d()),t&2){let o=c().$implicit;l(),q(o.getValue())}}function pt(t,n){if(t&1&&x(0,ct,1,1,"input",8)(1,dt,2,1,"span",9),t&2){let o=n.$implicit,e=c();C(o.row.original.id===-1||e.permisosService.filaRolEditando()[o.row.original.id]?0:1)}}function mt(t,n){if(t&1&&b(0,"input",10),t&2){let o=c(2);_("formControl",o.descripcion)}}function ut(t,n){if(t&1&&(s(0,"span",11),f(1),d()),t&2){let o=c().$implicit;l(),q(o.getValue())}}function _t(t,n){if(t&1&&x(0,mt,1,1,"input",10)(1,ut,2,1,"span",11),t&2){let o=n.$implicit,e=c();C(o.row.original.id===-1||e.permisosService.filaRolEditando()[o.row.original.id]?0:1)}}function ht(t,n){if(t&1&&(s(0,"span"),f(1),d()),t&2){let o=c(2);l(),q(o.fechaActual())}}function ft(t,n){if(t&1&&(s(0,"span"),f(1),d()),t&2){let o=c().$implicit;l(),A(" ",o.getValue()," ")}}function gt(t,n){if(t&1&&x(0,ht,2,1,"span")(1,ft,2,1,"span"),t&2){let o=n.$implicit,e=c();C(o.row.original.id===-1||e.permisosService.filaRolEditando()[o.row.original.id]?0:1)}}function xt(t,n){if(t&1&&(K(0),b(1,"span",14),B()),t&2){let o=n.$implicit;l(),_("innerHTML",o,U)}}function Ct(t,n){if(t&1&&V(0,xt,2,1,"ng-container",13),t&2){let o=c().$implicit;_("flexRender",o.column.columnDef.header)("flexRenderProps",o.getContext())}}function bt(t,n){if(t&1&&(s(0,"th",12),x(1,Ct,1,2,"ng-container"),d()),t&2){let o=n.$implicit;_("colSpan",o.colSpan),l(),C(o.isPlaceholder?-1:1)}}function vt(t,n){if(t&1&&(s(0,"tr"),E(1,bt,2,2,"th",12,Y),d()),t&2){let o=n.$implicit;l(),w(o.headers)}}function St(t,n){if(t&1&&(s(0,"tr")(1,"td",15)(2,"span"),f(3,"No hay roles a\xFAn..."),d()()()),t&2){let o=c(),e=N(7);l(),ie("colspan",o.tablaRoles().getAllColumns().length+(e.hiddenColumnIds().size>0?1:0))}}function Rt(t,n){if(t&1&&(K(0),b(1,"div",19),B()),t&2){let o=n.$implicit;l(),_("innerHTML",o,U)}}function Pt(t,n){if(t&1&&(s(0,"td",17),V(1,Rt,2,1,"ng-container",13),d()),t&2){let o=n.$implicit;l(),_("flexRender",o.column.columnDef.cell)("flexRenderProps",o.getContext())}}function yt(t,n){if(t&1&&(K(0),b(1,"div",19),B()),t&2){let o=n.$implicit;l(),_("innerHTML",o,U)}}function Tt(t,n){if(t&1&&(s(0,"li",27)(1,"span",28),f(2),d(),s(3,"span"),V(4,yt,2,1,"ng-container",13),d()()),t&2){let o=c().$implicit,e=c(3).$implicit;c(2);let i=N(7);l(2),A(" ",o.columnDef.header,": "),l(2),_("flexRender",i.getCell(o,e).column.columnDef.cell)("flexRenderProps",i.getCell(o,e).getContext())}}function Et(t,n){if(t&1&&x(0,Tt,5,3,"li",27),t&2){let o=n.$implicit;c(5);let e=N(7);C(e.hiddenColumnIds().has(o.id)?0:-1)}}function wt(t,n){if(t&1&&(s(0,"ul"),E(1,Et,1,1,null,null,_e),d(),b(3,"div",26)),t&2){let o=c(4);l(),w(o.tablaRoles().getAllLeafColumns())}}function Mt(t,n){t&1&&f(0," Asignar permisos al nuevo rol ")}function Ft(t,n){t&1&&f(0," Asignar permisos al rol ")}function It(t,n){if(t&1){let o=y();s(0,"button",29),T("click",function(){let i=R(o).$implicit,a=c(4);return P(a.permisosService.setPantallaSeleccionada(i))}),s(1,"div",24)(2,"div",30),b(3,"app-web-icon",31),s(4,"span",32),f(5),d()()()()}if(t&2){let o,e,i=n.$implicit,a=c(4);_("ngClass",oe(5,rt,i.id_pantalla===((o=a.permisosService.pantallaSeleccionada())==null?null:o.id_pantalla))),l(),_("ngClass",oe(7,st,i.id_pantalla===((e=a.permisosService.pantallaSeleccionada())==null?null:e.id_pantalla))),l(2),_("nombreIcono",i.icono)("estilos","h-4 w-4 md:h-5 md:w-5"),l(2),q(i.nombre)}}function At(t,n){if(t&1){let o=y();s(0,"tr",18)(1,"td")(2,"div",20),x(3,wt,4,0),s(4,"h3",21),x(5,Mt,1,0)(6,Ft,1,0),d(),s(7,"div",22)(8,"div",23),E(9,It,6,9,"button",24,lt),d(),s(11,"lista-permisos-pantalla",25),T("permisoToggle",function(i){R(o);let a=c().$implicit,p=c(2);return P(p.onPermisoToggle(i,a.original.id))}),d()()()()()}if(t&2){let o=c().$implicit,e=c(2),i=N(7);l(),ie("colspan",o.getVisibleCells().length+1),l(2),C(i.hiddenColumnIds().size!==0?3:-1),l(2),C(o.original.id===-1?5:6),l(4),w(e.pantallas),l(2),_("ngClass","w-full lg:max-h-[23.375rem] lg:overflow-hidden")("permisos",e.obtenerPermisos(o.original))("disabled",!e.permisosService.filaRolEditando()[o.original.id]&&o.original.id!==-1)}}function Ot(t,n){if(t&1&&(s(0,"tr",16),E(1,Pt,2,2,"td",17,Y),d(),x(3,At,12,6,"tr",18)),t&2){let o=n.$implicit;l(),w(o.getVisibleCells()),l(2),C(o.getIsExpanded()?3:-1)}}function kt(t,n){if(t&1&&E(0,Ot,4,1,null,null,Y),t&2){let o=c();w(o.tablaRoles().getRowModel().rows)}}function Vt(t,n){}var Ze=(()=>{let n=class n{constructor(){this.injector=g(ue),this.alertasService=g(je),this.cdr=g(xe),this.rolEnEdicion=h(null),this.permisosService=g($),this.appService=g(M),this.authService=g(J),this.permisos=Oe,this.fechaActual=v(()=>re(new Date,"dd/MM/yyyy HH:mm a")),this.nombre=new ne("",[G.required,G.minLength(3)]),this.descripcion=new ne("",[G.required,G.minLength(3)]),this.modoCreacion=v(()=>this.permisosService.modoCreacionRol()),this.alertaRoles=H.required("alertaRoles",{read:te}),this.nombreCell=H.required("nombreCell"),this.fechaCell=H.required("fechaCell"),this.descripcionCell=H.required("descripcionCell"),this.columnasPorDefecto=h([{id:"expansor",header:"",size:40,cell:e=>X(Ue,{inputs:{isExpanded:e.row.getIsExpanded(),disabled:this.appService.editando()},outputs:{toggleExpand:()=>this.onToggleRow(e.row)}})},{id:"nombre",size:100,accessorKey:"nombre",header:"Nombre",cell:this.nombreCell},{id:"descripcion",accessorKey:"descripcion",size:150,header:"Descripci\xF3n",cell:this.descripcionCell},{accessorKey:"creadoEn",header:"Creado en",accessorFn:e=>{let i=new Date(e.creadoEn);return isNaN(i.getTime())?"Fecha inv\xE1lida":re(i,"dd/MM/yyyy HH:mm a")},cell:this.fechaCell},{id:"acciones",header:"Acciones",cell:e=>{let a=e.row.original.id;if(a===-1)return X(se,{inputs:{visibles:e.column.getIsVisible(),acciones:[{tooltip:"Cancelar",icono:"remove-circle-outline",color:"error",disabled:this.appService.guardando(),eventoClick:S=>this.cancelarCreacion()},{tooltip:"Guardar",icono:"save-outline",color:"success",disabled:this.appService.guardando(),eventoClick:S=>this.onGuardarNuevoRol()}]}});let p=this.permisosService.filaRolEditando()[a],r=[];this.authService.tienePermisos(this.permisos.EDITAR_ROLES)&&r.push({tooltip:"Editar",icono:"pencil-outline",color:"accent",disabled:this.appService.editando()||this.appService.guardando(),eventoClick:S=>this.iniciarEdicion(e.row)});let F=p?[{tooltip:"Cancelar",icono:"remove-circle-outline",color:"error",disabled:this.appService.guardando(),eventoClick:S=>this.onCancelarEdicion(e.row)},{tooltip:"Guardar",icono:"save-outline",color:"success",disabled:this.appService.guardando(),eventoClick:S=>this.onGuardarEdicion(e.row)}]:r;return X(se,{inputs:{visibles:e.column.getIsVisible(),acciones:F}})}}]),this.tableState=h({expanded:{}}),this.tablaRoles=Ge(()=>({data:this.rolesQuery??[],columns:this.columnasPorDefecto(),getCoreRowModel:Qe(),getPaginationRowModel:Le(),getRowCanExpand:()=>!0,autoResetExpanded:!1,getFilteredRowModel:qe(),getExpandedRowModel:Ne(),manualPagination:!0,autoResetPageIndex:!1,state:{expanded:this.tableState().expanded,pagination:this.permisosService.paginacionRoles()},onExpandedChange:e=>{let i=typeof e=="function"?e(this.tableState().expanded):e;this.tableState.update(a=>u(m({},a),{expanded:i}))},onPaginationChange:e=>{let i=typeof e=="function"?e(this.permisosService.paginacionRoles()):e;this.permisosService.setPaginacionRoles({pageIndex:i.pageIndex,pageSize:i.pageSize})}}))}ngOnInit(){fe(()=>{this.permisosService.pestana(),this.permisosService.pestana()!=="rol"&&(this.nombre.reset(),this.descripcion.reset(),this.permisosService.setPermisosNuevoRol([]),this.permisosService.setPantallaSeleccionada(null),this.rolEnEdicion.set(null),this.permisosService.resetAllexceptPaginacion())},{injector:this.injector})}get rolesQuery(){let e=this.permisosService.rolesPermisosQuery.data()||[];return this.modoCreacion()?[{id:-1,nombre:"",descripcion:"",activo:null,creadoEn:this.fechaActual(),actualizadoEn:null,permisos:[]},...e]:e}get pantallas(){return this.appService.pantallasQuery.data()?.filter(e=>e.visible)?.sort((e,i)=>e.orden-i.orden)??[]}onPageChange(e){this.permisosService.setPaginacionRoles(e)}cancelarCreacion(){this.permisosService.setModoCreacionRol(!1),this.appService.setEditando(!1),this.tableState.update(e=>u(m({},e),{expanded:{}})),this.nombre.reset(),this.descripcion.reset(),this.permisosService.setPermisosNuevoRol([]),this.permisosService.setPantallaSeleccionada(null),this.cdr.detectChanges()}onCancelarEdicion(e){let i=e.original.id;this.permisosService.setEditandoFilaRol(i,!1),this.appService.setEditando(!1),this.permisosService.limpiarPermisosSeleccionados(i),this.rolEnEdicion.set(null),this.tableState.update(a=>u(m({},a),{expanded:{}})),this.nombre.reset(),this.descripcion.reset(),this.permisosService.setPantallaSeleccionada(null),this.cdr.detectChanges()}iniciarEdicion(e){let i=e.original,a=i.id;this.permisosService.setEditandoFilaRol(a,!0),this.rolEnEdicion.set(i),this.appService.setEditando(!0),this.onToggleRow(e,!0),setTimeout(()=>{this.nombre.setValue(i.nombre),this.descripcion.setValue(i.descripcion),this.nombre.markAsPristine(),this.descripcion.markAsPristine(),!this.permisosService.pantallaSeleccionada()&&this.pantallas.length>0&&this.permisosService.setPantallaSeleccionada(this.pantallas[0]),this.cdr.detectChanges()},0),this.permisosService.setPermisosSeleccionados(a,i.permisos)}onGuardarEdicion(e){return O(this,null,function*(){if(this.nombre.markAsTouched(),this.descripcion.markAsTouched(),this.nombre.invalid||this.descripcion.invalid){this.alertasService.error("Por favor, complete todos los campos requeridos.",5e3,this.alertaRoles(),"fixed flex p-4 transition-all ease-in-out bottom-4 right-4");return}this.appService.setGuardando(!0);let i=e.original,a=this.permisosService.getPermisosSeleccionados(i.id),p={nombre:this.nombre.value,descripcion:this.descripcion.value,permisos:a};try{yield this.permisosService.actualizarRolAsync(i.id,p),this.alertasService.success("Rol actualizado exitosamente.",5e3,this.alertaRoles(),"fixed flex p-4 transition-all ease-in-out bottom-4 right-4"),this.tableState.update(r=>u(m({},r),{expanded:{}})),this.permisosService.setEditandoFilaRol(i.id,!1),this.appService.setEditando(!1),this.rolEnEdicion.set(null),this.nombre.reset(),this.descripcion.reset(),this.permisosService.limpiarPermisosSeleccionados(i.id),this.permisosService.setPantallaSeleccionada(null),this.cdr.detectChanges(),this.permisosService.rolesPermisosQuery.refetch()}catch(r){console.error("Error al actualizar rol:",r),this.alertasService.error(`Error al actualizar el rol. ${r.error.message}.`,5e3,this.alertaRoles(),"fixed flex p-4 transition-all ease-in-out bottom-4 right-4")}finally{this.appService.setGuardando(!1)}})}onGuardarNuevoRol(){return O(this,null,function*(){if(this.nombre.markAsTouched(),this.descripcion.markAsTouched(),this.nombre.invalid||this.descripcion.invalid){this.alertasService.error("Por favor, complete todos los campos requeridos.",5e3,this.alertaRoles(),"fixed flex p-4 transition-all ease-in-out bottom-4 right-4");return}this.appService.setGuardando(!0);let e=this.permisosService.permisosNuevoRol(),i={nombre:this.nombre.value,descripcion:this.descripcion.value,permisos:e};try{yield this.permisosService.crearRolAsync(i),this.alertasService.success("Rol creado exitosamente.",5e3,this.alertaRoles(),"fixed flex p-4 transition-all ease-in-out bottom-4 right-4"),this.tableState.update(a=>u(m({},a),{expanded:{}})),this.cancelarCreacion(),this.cdr.detectChanges(),this.permisosService.rolesPermisosQuery.refetch()}catch(a){console.error("Error al crear rol:",a),this.alertasService.error(`Error al crear el rol. ${a.error.message}.`,5e3,this.alertaRoles(),"fixed flex p-4 transition-all ease-in-out bottom-4 right-4")}finally{this.appService.setGuardando(!1)}})}onToggleRow(e,i=!1){let a=e.id,p=this.tableState().expanded,r;i?r={[a]:!0}:(r=p[a]?{}:{[a]:!0},p[a]&&this.permisosService.setPantallaSeleccionada(null)),this.tableState.update(F=>u(m({},F),{expanded:r})),e.original.id===-1&&r[a]&&this.pantallas.length>0&&setTimeout(()=>{this.permisosService.pantallaSeleccionada()||this.permisosService.setPantallaSeleccionada(this.pantallas[0])},100)}obtenerPermisos(e){let i=this.permisosService.pantallaSeleccionada();if(!i)return[];let a=e.id,p=i.id_pantalla,r=this.pantallas.find(S=>S.id_pantalla===p)?.permisos||[];if(a===-1){let S=this.permisosService.permisosNuevoRol();return r.map(I=>u(m({},I),{concedido:S.some(j=>j.id_permiso===I.id_permiso&&j.concedido)}))}if(this.permisosService.filaRolEditando()[a]){let S=this.permisosService.getPermisosSeleccionados(a);return r.map(I=>u(m({},I),{concedido:S.some(j=>j.id_permiso===I.id_permiso&&j.concedido)}))}return r.map(S=>u(m({},S),{concedido:e.permisos.some(I=>I.id_permiso===S.id_permiso&&I.concedido)}))}onPermisoToggle(e,i){if(this.modoCreacion()){let a=this.permisosService.permisosNuevoRol(),p;e.activo?a.find(r=>r.id_permiso===e.permiso.id_permiso)?p=a.map(r=>r.id_permiso===e.permiso.id_permiso?u(m({},r),{concedido:!0}):r):p=[...a,u(m({},e.permiso),{concedido:!0})]:p=a.map(r=>r.id_permiso===e.permiso.id_permiso?u(m({},r),{concedido:!1}):r).filter(r=>r.concedido),this.permisosService.setPermisosNuevoRol(p)}else{let a=this.permisosService.getPermisosSeleccionados(i),p;e.activo?a.find(r=>r.id_permiso===e.permiso.id_permiso)?p=a.map(r=>r.id_permiso===e.permiso.id_permiso?u(m({},r),{concedido:!0}):r):p=[...a,u(m({},e.permiso),{concedido:!0})]:p=a.map(r=>r.id_permiso===e.permiso.id_permiso?u(m({},r),{concedido:!1}):r).filter(r=>r.concedido),this.permisosService.setPermisosSeleccionados(i,p)}}ngOnDestroy(){this.permisosService.setModoCreacionRol(!1),this.appService.setEditando(!1),this.permisosService.setEditandoFilaRol(0,!1),this.permisosService.resetPermisosSeleccionados(),this.rolEnEdicion.set(null),this.appService.setGuardando(!1),this.nombre.reset(null),this.descripcion.reset(null),this.permisosService.setPermisosNuevoRol([]),this.permisosService.setPantallaSeleccionada(null),this.cdr.detectChanges()}};n.\u0275fac=function(i){return new(i||n)},n.\u0275cmp=k({type:n,selectors:[["tabla-roles"]],viewQuery:function(i,a){i&1&&(Q(a.alertaRoles,it,5,te),Q(a.nombreCell,ot,5),Q(a.fechaCell,nt,5),Q(a.descripcionCell,at,5)),i&2&&he(4)},decls:17,vars:9,consts:[["nombreCell",""],["descripcionCell",""],["fechaCell",""],["tablaRol","responsiveTable"],["alertaRoles",""],["responsiveTable","",1,"table","w-full","rounded-md","table-sm","sm:table-md",3,"table"],[1,"sticky","top-0","z-20","bg-base-100"],[3,"cambioPaginacion","prefetchFunction","ngClass","estado","paginacion","mostrarInfo","mostrarSelectorTamano","mostrarExtremos","deshabilitado"],["placeholder","Inserte nombre","pattern","[a-zA-Z0-9\xE1\xE9\xED\xF3\xFA ]*","type","text",1,"input","input-sm","h-9","placeholder:text-gray-400",3,"formControl"],[1,"font-semibold","text-sm","md:text-base"],["placeholder","Inserte descripci\xF3n","pattern","[a-zA-Z0-9\xE1\xE9\xED\xF3\xFA ]*","type","text",1,"input","input-sm","h-9","placeholder:text-gray-400",3,"formControl"],[1,"text-sm","md:text-base"],[1,"p-2","text-left","first:rounded-tl-box","last:rounded-tr-box","bg-base-100","z-20",3,"colSpan"],[4,"flexRender","flexRenderProps"],[1,"text-left",3,"innerHTML"],[1,"text-center","text-gray-500"],[1,"bg-base-100"],[1,"py-1"],[1,"bg-base-300","border-none"],[3,"innerHTML"],[1,"bg-base-100","rounded-md","p-1","px-3","shadow-md","w-full"],[1,"text-base","font-bold","text-center","mt-3","mb-2"],[1,"w-full","flex","flex-col","lg:flex-row","gap-1","lg:gap-3","p-4"],[1,"flex","flex-row","lg:flex-col","gap-1","w-fit","flex-wrap"],[3,"ngClass"],[3,"permisoToggle","ngClass","permisos","disabled"],[1,"divider","my-1"],[1,"flex","my-2","flex-row","gap-2","items-center"],[1,"font-bold","text-base-content"],[3,"click","ngClass"],[1,"flex","items-center","gap-1","md:gap-2"],[3,"nombreIcono","estilos"],[1,"text-sm"]],template:function(i,a){if(i&1){let p=y();V(0,pt,2,1,"ng-template",null,0,L)(2,_t,2,1,"ng-template",null,1,L)(4,gt,2,1,"ng-template",null,2,L),s(6,"table",5,3)(8,"thead",6),E(9,vt,3,0,"tr",null,Y),d(),s(11,"tbody"),x(12,St,4,1,"tr")(13,kt,2,0),d()(),s(14,"app-paginador",7),T("cambioPaginacion",function(F){return R(p),P(a.onPageChange(F))})("prefetchFunction",function(F){return R(p),P(a.permisosService.prefetchRoles(F))}),d(),V(15,Vt,0,0,"ng-template",null,4,L)}i&2&&(l(6),_("table",a.tablaRoles()),l(3),w(a.tablaRoles.getHeaderGroups()),l(3),C(!a.rolesQuery.length&&!a.modoCreacion()?12:13),l(2),_("ngClass","flex flex-col sm:flex-row items-center justify-between gap-4 p-4 bg-base-100 sticky bottom-0 z-10 rounded-b-box")("estado",a.permisosService.paginacionRoles())("paginacion",a.permisosService.datosPaginadorRoles()??null)("mostrarInfo",!0)("mostrarSelectorTamano",!0)("mostrarExtremos",!0)("deshabilitado",a.permisosService.rolesPermisosQuery.isFetching()))},dependencies:[z,Z,ye,be,ve,Re,Se,Ke,He,Be,D,We],styles:["[_nghost-%COMP%]{display:block}"],changeDetection:0});let t=n;return t})();function zt(t,n){if(t&1){let o=y();s(0,"div",3),f(1),s(2,"button",10),T("click",function(){R(o);let i=c();return P(i.limpiarFiltro())}),b(3,"app-web-icon",11),d()()}if(t&2){let o=c();l(),A(' Filtrando: "',o.permisosService.filtroTexto(),'" ')}}function Dt(t,n){if(t&1){let o=y();s(0,"input",12),T("input",function(i){R(o);let a=c();return P(a.aplicarFiltro(i.target.value))}),d()}if(t&2){let o=c();_("value",o.permisosService.filtroTexto())}}function $t(t,n){if(t&1){let o=y();s(0,"button",13),T("click",function(){R(o);let i=c();return P(i.crearRol())}),b(1,"app-web-icon",14),f(2," Nuevo Rol "),d()}if(t&2){let o=c();_("disabled",o.appService.editando())}}function jt(t,n){t&1&&(s(0,"div",7),b(1,"span",15),s(2,"span",16),f(3,"Cargando roles..."),d()())}function Qt(t,n){t&1&&(s(0,"div",8),b(1,"app-web-icon",17),s(2,"span"),f(3,"Error al cargar los roles. "),d(),s(4,"button",18),f(5,"Reintentar"),d()())}function Nt(t,n){t&1&&b(0,"tabla-roles",9),t&2&&_("ngClass","flex flex-col")}var qi=(()=>{let n=class n{constructor(){this.authService=g(J),this.appService=g(M),this.permisosService=g($),this.destroy$=new ee,this.searchSubject=new ee,this.roles=[],this.rolSeleccionado=null}ngOnInit(){ke({eye:De,create:ze,shield:$e,addOutline:Ve}),this.searchSubject.pipe(ce(300),de(),pe(this.destroy$)).subscribe(e=>{this.permisosService.setFiltroTexto(e)})}get permisosQuery(){return this.permisosService.permisosQuery}get rolesQuery(){return this.appService.rolesQuery}cambiarPestana(e){this.appService.setEditando(!1),this.permisosService.setModoCreacion(!1),this.permisosService.setPestana(e)}seleccionarRol(e){this.rolSeleccionado=e}limpiarFiltro(){this.permisosService.limpiarFiltro()}aplicarFiltro(e){this.searchSubject.next(e)}crearRol(){this.permisosService.iniciarCrearRol()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}};n.\u0275fac=function(i){return new(i||n)},n.\u0275cmp=k({type:n,selectors:[["app-permisos-main"]],hostAttrs:[1,"flex","flex-col","w-full","h-full","sm:pl-3","relative","overflow-y-auto"],decls:11,vars:4,consts:[[1,"flex","flex-col","md:flex-row","md:pr-2","w-full","pb-2","md:pb-4","items-stretch","justify-center","md:justify-between","sticky","top-0","z-30","bg-base-300"],[1,"flex","items-center","gap-2","justify-center","md:justify-start"],[1,"font-bold","text-4xl","max-sm:text-2xl","mb-2","md:mb-0"],[1,"badge","badge-secondary","h-fit","md:h-6","badge-sm","my-auto","text-sm","md:text-base"],[1,"flex","flex-col","md:flex-row","gap-2","mt-1"],["type","text","placeholder","Buscar por nombre, email o rol...",1,"input","max-sm:input-sm","input-bordered","input-primary","w-full","sm:h-11","rounded-box","md:max-w-xs","placeholder:text-gray-500","placeholder:text-sm",3,"value"],[1,"btn","max-sm:btn-sm","btn-primary","sm:h-11","rounded-box",3,"disabled"],[1,"flex","justify-center","items-center","py-8"],[1,"alert","alert-error","mb-4"],[3,"ngClass"],["title","Limpiar filtro",1,"btn","h-5","w-5","btn-circle","btn-secondary","ml-1",3,"click"],["estilos","h-4 w-4","nombreIcono","close-circle-outline"],["type","text","placeholder","Buscar por nombre, email o rol...",1,"input","max-sm:input-sm","input-bordered","input-primary","w-full","sm:h-11","rounded-box","md:max-w-xs","placeholder:text-gray-500","placeholder:text-sm",3,"input","value"],[1,"btn","max-sm:btn-sm","btn-primary","sm:h-11","rounded-box",3,"click","disabled"],["estilos","h-6 w-6","nombreIcono","add-outline"],[1,"loading","loading-spinner","loading-lg","text-primary"],[1,"ml-2","text-base-content"],["estilos","h-6 w-6","nombreIcono","alert-circle-outline"],[1,"btn","btn-sm","btn-outline"]],template:function(i,a){i&1&&(s(0,"div",0)(1,"div",1)(2,"h2",2),f(3," Roles y permisos "),d(),x(4,zt,4,1,"div",3),d(),s(5,"div",4),x(6,Dt,1,1,"input",5),x(7,$t,3,1,"button",6),d()(),x(8,jt,4,0,"div",7)(9,Qt,6,0,"div",8)(10,Nt,1,1,"tabla-roles",9)),i&2&&(l(4),C(a.permisosService.filtroTexto()&&a.permisosService.pestana()==="rol"?4:-1),l(2),C(a.permisosService.pestana()==="rol"?6:-1),l(),C(a.authService.tienePermisos("PER000001")?7:-1),l(),C(a.rolesQuery.isPending()?8:a.rolesQuery.isError()?9:10))},dependencies:[we,z,Z,Pe,D,Ze],styles:[".permisos-container[_ngcontent-%COMP%]{max-width:1200px;margin:0 auto}.roles-card[_ngcontent-%COMP%], .permisos-card[_ngcontent-%COMP%]{border-radius:12px;box-shadow:0 4px 12px #0000000d;height:100%}.roles-card[_ngcontent-%COMP%]   ion-card-title[_ngcontent-%COMP%], .permisos-card[_ngcontent-%COMP%]   ion-card-title[_ngcontent-%COMP%]{font-size:18px;font-weight:600}.roles-card[_ngcontent-%COMP%]   ion-card-subtitle[_ngcontent-%COMP%], .permisos-card[_ngcontent-%COMP%]   ion-card-subtitle[_ngcontent-%COMP%]{margin-top:8px}ion-list[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]{--padding-start: 16px;--padding-end: 16px;--padding-top: 12px;--padding-bottom: 12px}ion-list[_ngcontent-%COMP%]   ion-item.selected[_ngcontent-%COMP%]{--background: rgba(var(--ion-color-primary-rgb), .1);--border-color: var(--ion-color-primary)}ion-list[_ngcontent-%COMP%]   ion-item.selected[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{color:var(--ion-color-primary);font-weight:600}ion-list[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-weight:500;margin-bottom:4px}ion-list[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:var(--ion-color-medium);font-size:13px}.categoria-permisos[_ngcontent-%COMP%]{margin-bottom:20px}.categoria-permisos[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-size:16px;font-weight:600;color:var(--ion-color-dark);border-bottom:1px solid var(--ion-color-light);padding-bottom:8px;margin-bottom:16px}.categoria-permisos[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]{--min-height: 44px}.actions-footer[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:12px;margin-top:30px}.no-selection[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;height:100%;min-height:300px}.no-selection[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{text-align:center}"],changeDetection:0});let t=n;return t})();export{qi as PermisosMainPage};
